var _ = require("lodash"),
spawn = require("child_process").spawn,
path = require("path"),
cwd = process.cwd().toString(),
extension_loader = require("../extension-loader");



/*******************************

Node Path and Arguments

*******************************/
var node = _.head(process.argv);
var commands = _.slice(process.argv, 2);




if (!require.main || require.main.filename !== __filename) {

    /*****************************

      Preload Options

    ******************************/

  //Register .js Extension for Loading
  require("../index");

  extension_loader.default(function(extension) {
    //Load Modifier
    var mod = /\.\//.test(extension.name) ? path.join(cwd, extension.name) : extension.name;
    mod = require(mod);


    //Init Mod with Options
    var options = extension.options || {};
    mod(options);

  });
} else {

  /*********************************************

  Command Line Interface

  *********************************************/
  var include;
  include = ["-r",__filename];
  commands = _.concat(include, commands);
  var child = spawn(node, commands, {
    stdio: "inherit",
    env:process.env,
    cwd:process.cwd()
  });

  child.on("exit", function(code) {
    process.exit(code);
  });
}
